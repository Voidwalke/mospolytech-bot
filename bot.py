"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –ú–æ—Å–ü–æ–ª–∏—Ç–µ—Ö
"""
import asyncio
import sys

from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import BotCommand, BotCommandScopeDefault, BotCommandScopeChat
from loguru import logger

from app.config import settings
from app.database import init_db
from app.handlers import setup_routers
from app.middlewares import AuthMiddleware, LoggingMiddleware, ThrottlingMiddleware


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger.remove()
logger.add(
    sys.stderr,
    format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
    level=settings.LOG_LEVEL,
    colorize=True
)
logger.add(
    "logs/bot_{time:YYYY-MM-DD}.log",
    rotation="1 day",
    retention="30 days",
    level="DEBUG",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}"
)


async def setup_bot_commands(bot: Bot):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (–º–µ–Ω—é)"""
    
    # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    user_commands = [
        BotCommand(command="start", description="üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"),
        BotCommand(command="help", description="‚ùì –ü–æ–º–æ—â—å"),
        BotCommand(command="faq", description="üìö –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã"),
        BotCommand(command="documents", description="üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —à–∞–±–ª–æ–Ω—ã"),
        BotCommand(command="schedule", description="üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"),
        BotCommand(command="tickets", description="üé´ –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è"),
        BotCommand(command="profile", description="üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"),
        BotCommand(command="links", description="üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏"),
        BotCommand(command="info", description="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—É–∑–µ"),
        BotCommand(command="fact", description="üé≤ –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç"),
    ]
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    admin_commands = user_commands + [
        BotCommand(command="admin", description="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"),
        BotCommand(command="stats", description="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
        BotCommand(command="broadcast", description="üì¢ –†–∞—Å—Å—ã–ª–∫–∞"),
    ]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö
    await bot.set_my_commands(user_commands, scope=BotCommandScopeDefault())
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    for admin_id in settings.ADMIN_IDS:
        try:
            await bot.set_my_commands(
                admin_commands, 
                scope=BotCommandScopeChat(chat_id=admin_id)
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
    
    logger.info("‚úÖ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")


async def on_startup(bot: Bot):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"""
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
    await init_db()
    logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    # –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ FAQ
    await seed_faq_data()
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
    await setup_bot_commands(bot)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
    bot_info = await bot.get_me()
    logger.info(f"ü§ñ –ë–æ—Ç: @{bot_info.username} ({bot_info.full_name})")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
    for admin_id in settings.ADMIN_IDS:
        try:
            await bot.send_message(
                admin_id,
                "üöÄ <b>–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!</b>\n\n"
                f"ü§ñ @{bot_info.username}\n"
                f"üìÖ –í—Ä–µ–º—è: {__import__('datetime').datetime.now().strftime('%d.%m.%Y %H:%M')}",
                parse_mode=ParseMode.HTML
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
    
    logger.info("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")


async def on_shutdown(bot: Bot):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞"""
    logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
    for admin_id in settings.ADMIN_IDS:
        try:
            await bot.send_message(
                admin_id,
                "üõë <b>–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>",
                parse_mode=ParseMode.HTML
            )
        except Exception:
            pass
    
    logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


async def seed_faq_data():
    """–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö FAQ"""
    from app.database import async_session, FAQCategory, FAQItem
    from sqlalchemy import select
    
    async with async_session() as session:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥–∞–Ω–Ω—ã–µ
        result = await session.execute(select(FAQCategory))
        if result.scalars().first():
            logger.debug("FAQ –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç")
            return
        
        # –°–æ–∑–¥–∞—ë–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        categories_data = [
            ("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "schedule", "–í–æ–ø—Ä–æ—Å—ã –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏–π –∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤", 1),
            ("üí∞ –°—Ç–∏–ø–µ–Ω–¥–∏–∏", "scholarship", "–í–æ–ø—Ä–æ—Å—ã –æ —Å—Ç–∏–ø–µ–Ω–¥–∏—è—Ö –∏ –≤—ã–ø–ª–∞—Ç–∞—Ö", 2),
            ("üìù –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ", "enrollment", "–í–æ–ø—Ä–æ—Å—ã –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏, –ø–µ—Ä–µ–≤–æ–¥–µ –∏ –æ—Ç—á–∏—Å–ª–µ–Ω–∏–∏", 3),
            ("üìö –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏", "debts", "–í–æ–ø—Ä–æ—Å—ã –æ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—è—Ö", 4),
            ("üè¢ –ü—Ä–∞–∫—Ç–∏–∫–∞", "practice", "–í–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–∞–∫—Ç–∏–∫–µ –∏ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ", 5),
            ("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", "documents", "–í–æ–ø—Ä–æ—Å—ã –æ —Å–ø—Ä–∞–≤–∫–∞—Ö –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö", 6),
            ("üìú –ü—Ä–∏–∫–∞–∑—ã", "orders", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–∫–∞–∑–∞—Ö —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞", 7),
            ("üìÜ –ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "calendar", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–º–µ—Å—Ç—Ä–∞—Ö –∏ –∫–∞–Ω–∏–∫—É–ª–∞—Ö", 8),
        ]
        
        categories = {}
        for name, slug, description, order in categories_data:
            cat = FAQCategory(
                name=name.split(" ", 1)[1],  # –£–±–∏—Ä–∞–µ–º emoji
                slug=slug,
                description=description,
                icon=name.split(" ")[0],
                order=order
            )
            session.add(cat)
            await session.flush()
            categories[slug] = cat
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã
        faq_items = [
            # –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            ("schedule", "–ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π?", 
             "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:\n\n"
             "1. –ù–∞ —Å–∞–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: https://rasp.dmami.ru\n"
             "2. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ: https://e.mospolytech.ru\n"
             "3. –í –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ú–æ—Å–ü–æ–ª–∏—Ç–µ—Ö–∞\n\n"
             "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ.", 
             "—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∑–∞–Ω—è—Ç–∏—è, –ø–∞—Ä—ã, –≤—Ä–µ–º—è",
             '[{"text": "üîó –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "url": "https://rasp.dmami.ru"}]'),
            
            ("schedule", "–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–æ–≤?",
             "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–æ–≤ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è:\n\n"
             "‚Ä¢ –ù–∞ —Å–∞–π—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏\n"
             "‚Ä¢ –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞\n"
             "‚Ä¢ –ù–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç–µ–Ω–¥–∞—Ö –¥–µ–∫–∞–Ω–∞—Ç–∞",
             "—ç–∫–∑–∞–º–µ–Ω—ã, —Å–µ—Å—Å–∏—è, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–æ–≤, –∑–∞—á–µ—Ç—ã",
             None),
            
            # –°—Ç–∏–ø–µ–Ω–¥–∏–∏
            ("scholarship", "–ö–∞–∫–∏–µ –≤–∏–¥—ã —Å—Ç–∏–ø–µ–Ω–¥–∏–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç?",
             "–í –ú–æ—Å–ü–æ–ª–∏—Ç–µ—Ö–µ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤ —Å—Ç–∏–ø–µ–Ω–¥–∏–π:\n\n"
             "üìö <b>–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∏–ø–µ–Ω–¥–∏—è</b>\n"
             "–ù–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º-–±—é–¥–∂–µ—Ç–Ω–∏–∫–∞–º –±–µ–∑ —Ç—Ä–æ–µ–∫\n\n"
             "üèÜ <b>–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∏–ø–µ–Ω–¥–∏—è</b>\n"
             "–ó–∞ –æ—Ç–ª–∏—á–Ω—É—é —É—á—ë–±—É –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n\n"
             "üë®‚Äçüë©‚Äçüëß <b>–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç–∏–ø–µ–Ω–¥–∏—è</b>\n"
             "–î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ –ª—å–≥–æ—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n\n"
             "üéØ <b>–ò–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏</b>\n"
             "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –†–§, –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§ –∏ –¥—Ä—É–≥–∏–µ",
             "—Å—Ç–∏–ø–µ–Ω–¥–∏—è, –¥–µ–Ω—å–≥–∏, –≤—ã–ø–ª–∞—Ç—ã, –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è, —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è",
             None),
            
            ("scholarship", "–ö–æ–≥–¥–∞ –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∏–ø–µ–Ω–¥–∏—è?",
             "–°—Ç–∏–ø–µ–Ω–¥–∏—è –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –µ–∂–µ–º–µ—Å—è—á–Ω–æ —Å 25 –ø–æ 30 —á–∏—Å–ª–æ.\n\n"
             "‚ö†Ô∏è –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:\n"
             "‚Ä¢ –ü–µ—Ä–≤–∞—è –≤—ã–ø–ª–∞—Ç–∞ ‚Äî –ø–æ—Å–ª–µ –∏–∑–¥–∞–Ω–∏—è –ø—Ä–∏–∫–∞–∑–∞ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏\n"
             "‚Ä¢ –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫—É—é –∫–∞—Ä—Ç—É –ú–ò–†",
             "–∫–æ–≥–¥–∞ —Å—Ç–∏–ø–µ–Ω–¥–∏—è, –¥–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã, —á–∏—Å–ª–æ",
             None),
            
            # –î–æ–∫—É–º–µ–Ω—Ç—ã
            ("documents", "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É –æ–± –æ–±—É—á–µ–Ω–∏–∏?",
             "–°–ø—Ä–∞–≤–∫—É –æ–± –æ–±—É—á–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å:\n\n"
             "1. <b>–û–Ω–ª–∞–π–Ω:</b> –ó–∞–∫–∞–∑–∞—Ç—å —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Üí –î–æ–∫—É–º–µ–Ω—Ç—ã ‚Üí –ó–∞–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n\n"
             "2. <b>–õ–∏—á–Ω–æ:</b> –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –¥–µ–∫–∞–Ω–∞—Ç —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º –∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–º –±–∏–ª–µ—Ç–æ–º\n\n"
             "–°—Ä–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è",
             "—Å–ø—Ä–∞–≤–∫–∞, –æ–± –æ–±—É—á–µ–Ω–∏–∏, –¥–ª—è –≤–æ–µ–Ω–∫–æ–º–∞—Ç–∞, –¥–ª—è –±–∞–Ω–∫–∞",
             '[{"text": "üîó –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "url": "https://e.mospolytech.ru"}]'),
            
            ("documents", "–ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π –±–∏–ª–µ—Ç?",
             "–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –±–∏–ª–µ—Ç–∞:\n\n"
             "1. –ù–∞–ø–∏—à–∏—Ç–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –∏–º—è –¥–µ–∫–∞–Ω–∞\n"
             "2. –ü—Ä–∏–ª–æ–∂–∏—Ç–µ —Ñ–æ—Ç–æ 3√ó4\n"
             "3. –û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ—à–ª–∏–Ω—É (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)\n"
             "4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –¥–µ–∫–∞–Ω–∞—Ç\n\n"
             "–°—Ä–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: 5-7 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π",
             "—Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π, –±–∏–ª–µ—Ç, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –ø–æ—Ç–µ—Ä—è–ª",
             None),
            
            # –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏
            ("debts", "–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–∏ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏?",
             "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—è—Ö –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:\n\n"
             "‚Ä¢ –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ ‚Üí –ó–∞—á—ë—Ç–Ω–∞—è –∫–Ω–∏–∂–∫–∞\n"
             "‚Ä¢ –ß–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å –≤ –¥–µ–∫–∞–Ω–∞—Ç\n\n"
             "–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø–µ—Ä–µ—Å–¥–∞—á—É.",
             "–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å, –¥–æ–ª–≥, –Ω–µ–∑–∞—á–µ—Ç, –ø–µ—Ä–µ—Å–¥–∞—á–∞",
             None),
            
            ("debts", "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–µ—Å–¥–∞—á—É?",
             "–ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø–µ—Ä–µ—Å–¥–∞—á—É:\n\n"
             "1. –£–∑–Ω–∞–π—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤ –¥–µ–∫–∞–Ω–∞—Ç–µ\n"
             "2. –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ—Å–¥–∞—á—É –≤ –¥–µ–∫–∞–Ω–∞—Ç–µ\n"
             "3. –Ø–≤–∏—Ç–µ—Å—å –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å –∑–∞—á—ë—Ç–∫–æ–π –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º\n\n"
             "‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ!",
             "–ø–µ—Ä–µ—Å–¥–∞—á–∞, —ç–∫–∑–∞–º–µ–Ω, –∫–æ–º–∏—Å—Å–∏—è",
             None),
            
            # –ü—Ä–∞–∫—Ç–∏–∫–∞
            ("practice", "–ö–æ–≥–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞?",
             "–°—Ä–æ–∫–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:\n\n"
             "‚Ä¢ –£—á–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞: 2-4 —Å–µ–º–µ—Å—Ç—Ä\n"
             "‚Ä¢ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞: 4-6 —Å–µ–º–µ—Å—Ç—Ä\n"
             "‚Ä¢ –ü—Ä–µ–¥–¥–∏–ø–ª–æ–º–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä\n\n"
             "–¢–æ—á–Ω—ã–µ —Å—Ä–æ–∫–∏ —É–∫–∞–∑–∞–Ω—ã –≤ —É—á–µ–±–Ω–æ–º –ø–ª–∞–Ω–µ –≤–∞—à–µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.",
             "–ø—Ä–∞–∫—Ç–∏–∫–∞, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è, —É—á–µ–±–Ω–∞—è, —Å—Ä–æ–∫–∏",
             None),
            
            # –ö–∞–ª–µ–Ω–¥–∞—Ä—å
            ("calendar", "–ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∫–∞–Ω–∏–∫—É–ª—ã?",
             "–ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏ –∫–∞–Ω–∏–∫—É–ª:\n\n"
             "‚ùÑÔ∏è <b>–ó–∏–º–Ω–∏–µ –∫–∞–Ω–∏–∫—É–ª—ã:</b>\n"
             "–ü–æ—Å–ª–µ –∑–∏–º–Ω–µ–π —Å–µ—Å—Å–∏–∏ (–∫–æ–Ω–µ—Ü —è–Ω–≤–∞—Ä—è ‚Äî –Ω–∞—á–∞–ª–æ —Ñ–µ–≤—Ä–∞–ª—è)\n"
             "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ~2 –Ω–µ–¥–µ–ª–∏\n\n"
             "‚òÄÔ∏è <b>–õ–µ—Ç–Ω–∏–µ –∫–∞–Ω–∏–∫—É–ª—ã:</b>\n"
             "–ü–æ—Å–ª–µ –ª–µ—Ç–Ω–µ–π —Å–µ—Å—Å–∏–∏ (–∏—é–ª—å ‚Äî –∞–≤–≥—É—Å—Ç)\n"
             "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ~2 –º–µ—Å—è—Ü–∞\n\n"
             "–¢–æ—á–Ω—ã–µ –¥–∞—Ç—ã —É–∫–∞–∑–∞–Ω—ã –≤ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.",
             "–∫–∞–Ω–∏–∫—É–ª—ã, –æ—Ç–¥—ã—Ö, –ø–µ—Ä–µ—Ä—ã–≤, –∑–∏–º–Ω–∏–µ, –ª–µ—Ç–Ω–∏–µ",
             None),
        ]
        
        for cat_slug, question, answer, keywords, links in faq_items:
            item = FAQItem(
                category_id=categories[cat_slug].id,
                question=question,
                answer=answer,
                keywords=keywords,
                links=links
            )
            session.add(item)
        
        await session.commit()
        logger.info("‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ FAQ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")


async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    # –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞
    bot = Bot(
        token=settings.BOT_TOKEN,
        default=DefaultBotProperties(
            parse_mode=ParseMode.HTML,
            link_preview_is_disabled=True
        )
    )
    
    # –°–æ–∑–¥–∞—ë–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä
    storage = MemoryStorage()
    dp = Dispatcher(storage=storage)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware
    dp.message.middleware(ThrottlingMiddleware())
    dp.message.middleware(LoggingMiddleware())
    dp.message.middleware(AuthMiddleware())
    dp.callback_query.middleware(LoggingMiddleware())
    dp.callback_query.middleware(AuthMiddleware())
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(setup_routers())
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    dp.startup.register(on_startup)
    dp.shutdown.register(on_shutdown)
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    from aiogram.types import ErrorEvent
    
    @dp.error()
    async def error_handler(error_event: ErrorEvent):
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {error_event.exception}")
        import traceback
        logger.error(traceback.format_exc())
        return True
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º polling
        logger.info("‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ polling...")
        await dp.start_polling(
            bot,
            allowed_updates=dp.resolve_used_update_types(),
            drop_pending_updates=True
        )
    finally:
        await bot.session.close()


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.exception(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

